// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============ Authentication & Users ============

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime
  type       String   @default("email") // 'email' | 'password_reset'

  @@unique([identifier, token])
  @@index([identifier])
  @@index([expires])
}

// ============ Users (Multi-tenant) ============

model User {
  id            String    @id @default(cuid())
  email         String?   @unique
  emailVerified DateTime?
  phone         String?   @unique
  name          String?
  image         String?   @db.Text
  password      String?
  bio           String?   @db.Text

  // Role & Status
  role   UserRole   @default(SUBSCRIBER)
  status UserStatus @default(ACTIVE)

  // Creator-specific fields
  hourlyRate    Float?
  profileImage  String? @db.Text
  videoIntroUrl String? @db.Text // Video introduction for creators
  isCreator     Boolean @default(false)
  isFeatured    Boolean @default(false) // Admin-controlled featured status
  minHours      Int     @default(2) // Minimum booking duration
  location      String? // Primary meeting city (e.g., "Tokyo")
  noGoZones     String? @db.Text // JSON list of prohibited areas
  averageRating Float? // Aggregated review score

  // Stripe integration
  stripeCustomerId String? @unique
  stripeConnectId  String? @unique // For creator payouts

  // KYC/Verification
  kycStatus          KYCStatus @default(NOT_STARTED)
  kycVerifiedAt      DateTime?
  kycRejectionReason String?
  governmentIdUrl    String?   @db.Text
  livelinessPhotoUrl String?   @db.Text
  dateOfBirth        DateTime?

  // Email verification
  emailVerificationToken        String?   @unique
  emailVerificationTokenExpires DateTime?

  // Relationships
  accounts                 Account[]
  sessions                 Session[]
  sentMessages             Message[]      @relation("Sender")
  receivedMessages         Message[]      @relation("Recipient")
  subscriptions            Subscription[] @relation("Subscriber")
  creatorSubscriptions     Subscription[] @relation("Creator")
  profileViewsAsViewer     ProfileView[]  @relation("ProfileViewer")
  profileViewsAsViewedUser ProfileView[]  @relation("ProfileViewedUser")
  earnings                 Earning[]
  posts                    Post[]         @relation("PostCreator")
  kyc                      KYCSubmission?
  userProfile              UserProfile?
  userCredits              UserCredits?
  reportsSubmitted         Report[]       @relation("ReportSubmitter")
  reportsReceived          Report[]       @relation("ReportedUser")
  creatorBookings          Booking[]      @relation("CreatorBookings")
  clientBookings           Booking[]      @relation("ClientBookings")
  sentChats                Chat[]         @relation("ChatSender")
  receivedChats            Chat[]         @relation("ChatRecipient")
  creatorReviews           Review[]       @relation("CreatorReviews")
  clientReviews            Review[]       @relation("ClientReviews")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
  @@index([status])
  @@index([kycStatus])
  @@index([role])
}

enum UserRole {
  SUBSCRIBER
  CREATOR
  ADMIN
}

enum UserStatus {
  ACTIVE
  SUSPENDED
  BANNED
}

enum KYCStatus {
  NOT_STARTED
  PENDING
  VERIFIED
  REJECTED
}

// ============ Profiles & Browsing ============

model UserProfile {
  id                     String   @id @default(cuid())
  userId                 String   @unique
  bio                    String?  @db.Text
  location               String?
  interests              String[] @default([])
  verificationPercentage Float    @default(0)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

model ProfileView {
  id         String @id @default(cuid())
  viewedBy   String
  viewedUser String

  subscriber User @relation("ProfileViewer", fields: [viewedBy], references: [id], onDelete: Cascade)
  creator    User @relation("ProfileViewedUser", fields: [viewedUser], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([viewedBy, viewedUser])
  @@index([viewedBy])
  @@index([viewedUser])
}

// ============ Posts & Content ============

model Post {
  id        String @id @default(cuid())
  creatorId String
  content   String @db.Text

  // Media
  imageUrl String? @db.Text
  videoUrl String? @db.Text

  // Privacy & Access
  isSubscriberOnly Boolean @default(false)

  // Engagement
  likes    Int @default(0)
  comments Int @default(0)

  creator User @relation("PostCreator", fields: [creatorId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([creatorId])
  @@index([isSubscriberOnly])
  @@index([createdAt])
}

// ============ Messaging ============

model Message {
  id          String @id @default(cuid())
  senderId    String
  recipientId String
  content     String @db.Text

  // Paid messaging
  isPaidMessage Boolean @default(false)
  costCredits   Float?  @default(0)

  // Status
  readAt DateTime?

  sender    User @relation("Sender", fields: [senderId], references: [id], onDelete: Cascade)
  recipient User @relation("Recipient", fields: [recipientId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([senderId])
  @@index([recipientId])
  @@index([createdAt])
}

model UserCredits {
  id      String @id @default(cuid())
  userId  String @unique
  credits Float  @default(0)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

// ============ Subscriptions ============

model Subscription {
  id           String           @id @default(cuid())
  subscriberId String
  creatorId    String
  tier         SubscriptionTier @default(BASIC)

  // Stripe integration
  stripeSubscriptionId String?            @unique
  status               SubscriptionStatus @default(ACTIVE)

  price        Float
  billingCycle BillingCycle @default(MONTHLY)

  renewsAt    DateTime?
  cancelledAt DateTime?

  subscriber User @relation("Subscriber", fields: [subscriberId], references: [id], onDelete: Cascade)
  creator    User @relation("Creator", fields: [creatorId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([subscriberId, creatorId])
  @@index([subscriberId])
  @@index([creatorId])
  @@index([status])
}

enum SubscriptionTier {
  BASIC
  PREMIUM
  VIP
}

enum SubscriptionStatus {
  ACTIVE
  CANCELLED
  PAUSED
  EXPIRED
}

enum BillingCycle {
  MONTHLY
  YEARLY
}

// ============ Earnings & Payouts ============

model Earning {
  id        String        @id @default(cuid())
  creatorId String
  amount    Float
  source    EarningSource

  // Stripe charge reference
  stripeChargeId String?

  creator User @relation(fields: [creatorId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([creatorId])
  @@index([createdAt])
}

enum EarningSource {
  SUBSCRIPTION
  PAID_MESSAGE
  TIP
  BOOKING
}

// ============ KYC (Know Your Customer) ============

model KYCSubmission {
  id     String @id @default(cuid())
  userId String @unique

  // Personal info
  firstName          String
  lastName           String
  dateOfBirth        DateTime
  governmentIdType   IDType
  governmentIdNumber String

  // Documents
  governmentIdImageUrl String  @db.Text
  governmentIdBackUrl  String? @db.Text
  livelinessImageUrl   String  @db.Text

  // KYC Status
  status               KYCStatus @default(PENDING)
  verificationProvider String? // 'hypeverge', 'jumio', etc.
  providerReference    String?
  rejectionReason      String?   @db.Text

  verifiedAt DateTime?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([status])
}

enum IDType {
  PASSPORT
  DRIVER_LICENSE
  NATIONAL_ID
  VISA
}

// ============ Bookings (The "Twist") ============

model Booking {
  id        String @id @default(cuid())
  creatorId String
  clientId  String

  // Booking Details
  startTime         DateTime
  endTime           DateTime
  durationHours     Float // Computed from startTime/endTime
  totalPriceInCents Int // Captured at booking request time

  // Status
  status BookingStatus @default(PENDING)

  // Location & Notes
  meetingLocation String  @db.Text
  notes           String? @db.Text

  // Payment
  stripePaymentIntentId String?   @unique // Stripe pre-authorization
  paymentCapturedAt     DateTime?

  // Relations
  creator User     @relation("CreatorBookings", fields: [creatorId], references: [id], onDelete: Cascade)
  client  User     @relation("ClientBookings", fields: [clientId], references: [id], onDelete: Cascade)
  chats   Chat[]   @relation("BookingChats")
  reviews Review[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([creatorId])
  @@index([clientId])
  @@index([status])
  @@index([startTime])
  @@index([createdAt])
}

enum BookingStatus {
  PENDING
  APPROVED
  REJECTED
  COMPLETED
  CANCELLED
}

// ============ Chat (Booking-Scoped) ============

model Chat {
  id          String @id @default(cuid())
  bookingId   String
  senderId    String
  recipientId String
  message     String @db.Text

  // Status
  isRead Boolean   @default(false)
  readAt DateTime?

  // Relations
  booking   Booking @relation("BookingChats", fields: [bookingId], references: [id], onDelete: Cascade)
  sender    User    @relation("ChatSender", fields: [senderId], references: [id], onDelete: Cascade)
  recipient User    @relation("ChatRecipient", fields: [recipientId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([bookingId])
  @@index([senderId])
  @@index([recipientId])
  @@index([createdAt])
}

// ============ Reviews ============

model Review {
  id        String @id @default(cuid())
  bookingId String @unique // One review per booking
  creatorId String
  clientId  String

  // Review Content
  rating  Int // 1-5 stars
  comment String? @db.Text

  // Who wrote this review
  reviewedBy   String // creatorId or clientId
  reviewedUser String // The user being reviewed

  createdAt DateTime @default(now())

  // Relations
  booking Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  creator User    @relation("CreatorReviews", fields: [creatorId], references: [id], onDelete: Cascade)
  client  User    @relation("ClientReviews", fields: [clientId], references: [id], onDelete: Cascade)

  @@index([bookingId])
  @@index([creatorId])
  @@index([clientId])
  @@index([createdAt])
}

// ============ Admin & Moderation ============

model Report {
  id             String       @id @default(cuid())
  reportedUserId String
  reportedBy     String
  reason         String
  description    String       @db.Text
  status         ReportStatus @default(OPEN)

  reportedUser User @relation("ReportedUser", fields: [reportedUserId], references: [id], onDelete: Cascade)
  submitter    User @relation("ReportSubmitter", fields: [reportedBy], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([reportedUserId])
  @@index([reportedBy])
  @@index([status])
}

enum ReportStatus {
  OPEN
  INVESTIGATING
  RESOLVED
  DISMISSED
}
