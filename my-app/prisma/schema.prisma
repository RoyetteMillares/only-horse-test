// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============ Authentication & Users ============

model Account {
  id                 String  @id @default(cuid())
  userId             String
  type               String
  provider           String
  providerAccountId  String
  refresh_token      String?  @db.Text
  access_token       String?  @db.Text
  expires_at         Int?
  token_type         String?
  scope              String?
  id_token           String?  @db.Text
  session_state      String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id        String   @id @default(cuid())
  sessionToken String  @unique
  userId    String
  expires   DateTime
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime
  type       String    @default("email") // 'email' | 'password_reset'

  @@unique([identifier, token])
  @@index([identifier])
  @@index([expires])
}

// ============ Users (Multi-tenant) ============

model User {
  id                    String     @id @default(cuid())
  email                 String?    @unique
  emailVerified         DateTime?
  phone                 String?    @unique
  name                  String?
  image                 String?    @db.Text
  password              String?
  bio                   String?    @db.Text
  
  // Role & Status
  role                  UserRole   @default(SUBSCRIBER)
  status                UserStatus @default(ACTIVE)
  
  // Creator-specific fields
  hourlyRate            Float?
  profileImage          String?    @db.Text
  isCreator             Boolean    @default(false)
  
  // Stripe integration
  stripeCustomerId      String?    @unique
  stripeConnectId       String?    @unique  // For creator payouts
  
  // KYC/Verification
  kycStatus             KYCStatus  @default(NOT_STARTED)
  kycVerifiedAt         DateTime?
  kycRejectionReason    String?
  governmentIdUrl       String?    @db.Text
  livelinessPhotoUrl    String?    @db.Text
  dateOfBirth           DateTime?
  

  // Email verification
  emailVerificationToken String?    @unique
  emailVerificationTokenExpires DateTime?

  // Relationships
  accounts              Account[]
  sessions              Session[]
  sentMessages          Message[]  @relation("Sender")
  receivedMessages      Message[]  @relation("Recipient")
  subscriptions         Subscription[] @relation("Subscriber")
  creatorSubscriptions  Subscription[] @relation("Creator")
  profileViewsAsViewer  ProfileView[] @relation("ProfileViewer")
  profileViewsAsViewedUser ProfileView[] @relation("ProfileViewedUser")
  earnings              Earning[]
  kyc                   KYCSubmission?
  userProfile           UserProfile?
  userCredits           UserCredits?
  reportsSubmitted      Report[] @relation("ReportSubmitter")
  reportsReceived       Report[] @relation("ReportedUser")
  
  createdAt             DateTime   @default(now())
  updatedAt             DateTime   @updatedAt

  @@index([email])
  @@index([status])
  @@index([kycStatus])
  @@index([role])
}

enum UserRole {
  SUBSCRIBER
  CREATOR
  ADMIN
}

enum UserStatus {
  ACTIVE
  SUSPENDED
  BANNED
}

enum KYCStatus {
  NOT_STARTED
  PENDING
  VERIFIED
  REJECTED
}

// ============ Profiles & Browsing ============

model UserProfile {
  id              String   @id @default(cuid())
  userId          String   @unique
  bio             String?  @db.Text
  location        String?
  interests       String[] @default([])
  verificationPercentage Float @default(0)
  
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([userId])
}

model ProfileView {
  id              String   @id @default(cuid())
  viewedBy        String
  viewedUser      String
  
  subscriber      User     @relation("ProfileViewer", fields: [viewedBy], references: [id], onDelete: Cascade)
  creator         User     @relation("ProfileViewedUser", fields: [viewedUser], references: [id], onDelete: Cascade)
  
  createdAt       DateTime @default(now())

  @@unique([viewedBy, viewedUser])
  @@index([viewedBy])
  @@index([viewedUser])
}

// ============ Messaging ============

model Message {
  id              String   @id @default(cuid())
  senderId        String
  recipientId     String
  content         String   @db.Text
  
  // Paid messaging
  isPaidMessage   Boolean  @default(false)
  costCredits     Float?   @default(0)
  
  // Status
  readAt          DateTime?
  
  sender          User     @relation("Sender", fields: [senderId], references: [id], onDelete: Cascade)
  recipient       User     @relation("Recipient", fields: [recipientId], references: [id], onDelete: Cascade)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([senderId])
  @@index([recipientId])
  @@index([createdAt])
}

model UserCredits {
  id              String   @id @default(cuid())
  userId          String   @unique
  credits         Float    @default(0)
  
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([userId])
}

// ============ Subscriptions ============

model Subscription {
  id                  String     @id @default(cuid())
  subscriberId        String
  creatorId           String
  tier                SubscriptionTier @default(BASIC)
  
  // Stripe integration
  stripeSubscriptionId String?   @unique
  status              SubscriptionStatus @default(ACTIVE)
  
  price               Float
  billingCycle        BillingCycle @default(MONTHLY)
  
  renewsAt            DateTime?
  cancelledAt         DateTime?
  
  subscriber          User       @relation("Subscriber", fields: [subscriberId], references: [id], onDelete: Cascade)
  creator             User       @relation("Creator", fields: [creatorId], references: [id], onDelete: Cascade)
  
  createdAt           DateTime   @default(now())
  updatedAt           DateTime   @updatedAt

  @@unique([subscriberId, creatorId])
  @@index([subscriberId])
  @@index([creatorId])
  @@index([status])
}

enum SubscriptionTier {
  BASIC
  PREMIUM
  VIP
}

enum SubscriptionStatus {
  ACTIVE
  CANCELLED
  PAUSED
  EXPIRED
}

enum BillingCycle {
  MONTHLY
  YEARLY
}

// ============ Earnings & Payouts ============

model Earning {
  id              String   @id @default(cuid())
  creatorId       String
  amount          Float
  source          EarningSource
  
  // Stripe charge reference
  stripeChargeId  String?
  
  creator         User     @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  
  createdAt       DateTime @default(now())

  @@index([creatorId])
  @@index([createdAt])
}

enum EarningSource {
  SUBSCRIPTION
  PAID_MESSAGE
  TIP
}

// ============ KYC (Know Your Customer) ============

model KYCSubmission {
  id                    String   @id @default(cuid())
  userId                String   @unique
  
  // Personal info
  firstName             String
  lastName              String
  dateOfBirth           DateTime
  governmentIdType      IDType
  governmentIdNumber    String
  
  // Documents
  governmentIdImageUrl  String   @db.Text
  governmentIdBackUrl   String?  @db.Text
  livelinessImageUrl    String   @db.Text
  
  // KYC Status
  status                KYCStatus @default(PENDING)
  verificationProvider  String?  // 'hypeverge', 'jumio', etc.
  providerReference     String?
  rejectionReason       String?  @db.Text
  
  verifiedAt            DateTime?
  
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([userId])
  @@index([status])
}

enum IDType {
  PASSPORT
  DRIVER_LICENSE
  NATIONAL_ID
  VISA
}

// ============ Admin & Moderation ============

model Report {
  id              String   @id @default(cuid())
  reportedUserId  String
  reportedBy      String
  reason          String
  description     String   @db.Text
  status          ReportStatus @default(OPEN)
  
  reportedUser    User     @relation("ReportedUser", fields: [reportedUserId], references: [id], onDelete: Cascade)
  submitter       User     @relation("ReportSubmitter", fields: [reportedBy], references: [id], onDelete: Cascade)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([reportedUserId])
  @@index([reportedBy])
  @@index([status])
}

enum ReportStatus {
  OPEN
  INVESTIGATING
  RESOLVED
  DISMISSED
}
